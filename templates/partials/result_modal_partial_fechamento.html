<!-- Modal -->
<div id="jornadaModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="fecharModal()">&times;</span>
        <h3>Jornada do Motorista - {{ inicio }} a {{ fim }}</h3>

        <h4>{{ nome }}</h4>

        <!-- Campos de Soma -->
        <div class="soma-container">
            <p><strong>Total Tempo Refeição:</strong> <span id="soma-refeicao">00:00</span></p>
            <p><strong>Total Interstício:</strong> <span id="soma-intersticio">00:00</span></p>
            <p><strong>Total Tempo Intervalo:</strong> <span id="soma-intervalo">00:00</span></p>
            <p><strong>Total Tempo C/D:</strong> <span id="soma-carga">00:00</span></p>
            <p><strong>Total Jornada Total:</strong> <span id="soma-jornada">00:00</span></p>
            <p><strong>Total Tempo Direção:</strong> <span id="soma-direcao">00:00</span></p>
            <p><strong>Total Direção sem Pausa:</strong> <span id="soma-sem-pausa">00:00</span></p>
            <p><strong>Nº de Infrações:</strong> <span id="soma-infracoes">0</span></p>
        </div>

        <!-- Tabela de Jornadas -->
        <div class="table-wrapper">
            <div class="table-scroll">
                <table>
                    <thead>
                    <tr>
                        <th>Data</th>
                        <th>Dia</th>
                        <th>Placa</th>
                        <th>Início da Jornada</th>
                        <th>Início Refeição</th>
                        <th>Fim Refeição</th>
                        <th>Fim da Jornada</th>
                        <th>Tempo Refeição</th>
                        <th>Interstício</th>
                        <th>Tempo Intervalo</th>
                        <th>Tempo C/D</th>
                        <th>Jornada Total</th>
                        <th>Tempo Direção</th>
                        <th>Direção s/ Pausa</th>
                        <th style="min-width: 600px;">Infração</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in resultados %}
                    <tr>
                        <td>{{ row.data.strftime('%d/%m/%Y') if row.data else '' }}</td>
                        <td>{{ row.dia_da_semana or '' }}</td>
                        <td>{{ row.placa or '' }}</td>
                        <td>{{ row.inicio_jornada or '' }}</td>
                        <td>{{ row.in_refeicao or '' }}</td>
                        <td>{{ row.fim_refeicao or '' }}</td>
                        <td>{{ row.fim_jornada or '' }}</td>
                        <td>{{ row.tempo_refeicao or '' }}</td>
                        <td>{{ row.intersticio or '' }}</td>
                        <td>{{ row.tempo_intervalo or '' }}</td>
                        <td>{{ row.tempo_carga_descarga or '' }}</td>
                        <td>{{ row.jornada_total or '' }}</td>
                        <td>{{ row.tempo_direcao or '' }}</td>
                        <td>{{ row.direcao_sem_pausa or '' }}</td>
                        <td class="infracao-cell">{{ (row.desc_infracao or '').replace('\n', ' | ') }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botões -->
        <div class="modal-buttons">
            <button onclick="baixarExcel()">Download Excel</button>
            <button onclick="baixarPDF()">Download PDF</button>
        </div>
    </div>
</div>

<!-- Inclui a barra de progresso -->
{% include 'partials/progress_bar.html' %}

<!-- CSS básico do modal -->
<style>
    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        width: 95%;
        max-width: 1400px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        margin: 0 auto;
    }

    .table-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        margin: 20px 0;
    }

    .table-scroll {
        overflow-x: auto;
        margin-bottom: 12px; /* Espaço para a barra de rolagem */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
    }

    th {
        background-color: #2C3E50;
        color: #FFFFFF;
        padding: 8px;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 1;
        min-width: 80px;
        height: 40px;
    }

    td {
        padding: 8px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
        height: 40px;
        line-height: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .infracao-cell {
        min-width: 600px;
        white-space: nowrap;
        text-align: left;
        padding-left: 12px;
        padding-right: 12px;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .soma-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .soma-container p {
        margin: 5px 0;
        white-space: nowrap;
    }

    .modal-close {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #666;
        z-index: 1;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-buttons {
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* Estilização da barra de rolagem */
    .table-scroll::-webkit-scrollbar {
        height: 12px;
        position: sticky;
        bottom: 0;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
        border: 2px solid #f1f1f1;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
    function baixarExcel() {
        const tabela = document.querySelector("#jornadaModal table");
        const linhas = tabela.querySelectorAll("tbody tr");
        const dadosTabela = [];

        progressManager.startOperation('Gerando Excel', 'Preparando dados...');

        linhas.forEach(linha => {
            const celulas = linha.querySelectorAll("td");
            const linhaDados = [];
            celulas.forEach(td => linhaDados.push(td.innerText.trim()));
            dadosTabela.push(linhaDados);
        });

        const totais = {
            refeicao: document.getElementById("soma-refeicao").innerText.trim(),
            intersticio: document.getElementById("soma-intersticio").innerText.trim(),
            intervalo: document.getElementById("soma-intervalo").innerText.trim(),
            carga: document.getElementById("soma-carga").innerText.trim(),
            jornada: document.getElementById("soma-jornada").innerText.trim(),
            direcao: document.getElementById("soma-direcao").innerText.trim(),
            sem_pausa: document.getElementById("soma-sem-pausa").innerText.trim(),
            infracoes: document.getElementById("soma-infracoes").innerText.trim(),
        };

        const nome = document.querySelector("#jornadaModal h4").innerText.trim();
        const periodo = document.querySelector("#jornadaModal h3").innerText.trim();
        const match = periodo.match(/(\d{2}\/\d{2}\/\d{4}) a (\d{2}\/\d{2}\/\d{4})/);

        if (!match) {
            progressManager.finishOperation(() => {
                alert("Período não encontrado no título do modal!");
            });
            return;
        }

        const [, inicio, fim] = match;

        const payload = {
            nome_motorista: nome,
            data_inicio: inicio,
            data_fim: fim,
            totais: totais,
            tabela: dadosTabela
        };

        progressManager.updateProgress(30, 'Enviando dados para o servidor...');

        fetch("/api/export_excel", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
        })
        .then(response => {
            progressManager.updateProgress(60, 'Gerando arquivo Excel...');
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error("Erro ao gerar o Excel");
            }
        })
        .then(blob => {
            progressManager.updateProgress(90, 'Preparando download...');
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `jornada_motorista_${nome.replace(/\s+/g, '_')}_${inicio.replace(/\//g, '-')}_a_${fim.replace(/\//g, '-')}.xlsx`;
            document.body.appendChild(a);
            
            progressManager.finishOperation(() => {
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            });
        })
        .catch(error => {
            progressManager.finishOperation(() => {
                alert("Erro ao baixar Excel: " + error.message);
            });
        });
    }

    function baixarPDF() {
        const tabela = document.querySelector("#jornadaModal table");
        const linhas = tabela.querySelectorAll("tbody tr");
        const dadosTabela = [];

        progressManager.startOperation('Gerando PDF', 'Preparando dados...');

        linhas.forEach(linha => {
            const celulas = linha.querySelectorAll("td");
            const linhaDados = [];
            celulas.forEach(td => linhaDados.push(td.innerText.trim()));
            dadosTabela.push(linhaDados);
        });

        const totais = {
            refeicao: document.getElementById("soma-refeicao").innerText.trim(),
            intersticio: document.getElementById("soma-intersticio").innerText.trim(),
            intervalo: document.getElementById("soma-intervalo").innerText.trim(),
            carga: document.getElementById("soma-carga").innerText.trim(),
            jornada: document.getElementById("soma-jornada").innerText.trim(),
            direcao: document.getElementById("soma-direcao").innerText.trim(),
            sem_pausa: document.getElementById("soma-sem-pausa").innerText.trim(),
            infracoes: document.getElementById("soma-infracoes").innerText.trim(),
        };

        const nome = document.querySelector("#jornadaModal h4").innerText.trim();
        const periodo = document.querySelector("#jornadaModal h3").innerText.trim();
        const match = periodo.match(/(\d{2}\/\d{2}\/\d{4}) a (\d{2}\/\d{2}\/\d{4})/);

        if (!match) {
            progressManager.finishOperation(() => {
                alert("Período não encontrado no título do modal!");
            });
            return;
        }

        const [, inicio, fim] = match;

        const payload = {
            nome_motorista: nome,
            data_inicio: inicio,
            data_fim: fim,
            totais: totais,
            tabela: dadosTabela
        };

        progressManager.updateProgress(30, 'Enviando dados para o servidor...');
            
        fetch("/api/export_pdf", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
        })
        .then(response => {
            progressManager.updateProgress(60, 'Gerando arquivo PDF...');
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error("Erro ao gerar o PDF");
            }
        })
        .then(blob => {
            progressManager.updateProgress(90, 'Preparando download...');
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `jornada_motorista_${nome.replace(/\s+/g, '_')}_${inicio.replace(/\//g, '-')}_a_${fim.replace(/\//g, '-')}.pdf`;
            document.body.appendChild(a);
            
            progressManager.finishOperation(() => {
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            });
        })
        .catch(error => {
            progressManager.finishOperation(() => {
                alert("Erro ao baixar PDF: " + error.message);
            });
        });
    }
</script>

