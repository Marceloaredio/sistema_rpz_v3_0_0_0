<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RPZ</title>

    <!-- Primeiro jQuery -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>

    <!-- Depois o SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Depois o progress_bar.html que define o progressManager -->
    {% include 'partials/progress_bar.html' %}

    <!-- Depois o progress.js que usa o progressManager -->
    <script src="{{ url_for('static', filename='js/progress.js') }}"></script>

    <!-- CSS e JS para conflitos -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/conflict_modal.css') }}" />
    <script src="{{ url_for('static', filename='js/conflict-utils.js') }}"></script>
    
    <!-- Por √∫ltimo o jornada-1.0.0.js que usa todos acima -->
    <script src="{{ url_for('static', filename='js/jornada-1.0.0.js') }}"></script>
    
    <!-- CSS para Modal Overlay -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal_overlay.css') }}"/>

    <style>
        #tabela-confirmacao thead th {
            position: sticky;
            top: 0;
            background: #222;
            color: white;
            z-index: 2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            text-align: center;
        }

        th {
            background-color: #2C3E50;
            color: #FFFFFF;
            padding: 4px 6px;
            font-weight: bold;
            white-space: pre-line;
            font-size: 11px;
            min-width: 80px;
        }

        td {
            padding: 4px 6px;
            border-bottom: 1px solid #e0e0e0;
            color: #1F2937;
            text-align: center;
            vertical-align: middle;
            font-size: 13px;
        }

        tr:nth-child(odd) td {
            background-color: #FFFFFF;
        }

        tr:nth-child(even) td {
            background-color: #F9FAFB;
        }

        tr.old-line td {
            background-color: #8ebeec;
        }

        tr.old-line:hover td {
            background-color: #608dec;
        }

        tr.has_infraction td {
            background-color: #bb8990;
        }

        tr.has_infraction:hover td {
            background-color: #c26a78;
        }

        tr:hover td {
            background-color: #E5E7EB;
        }

        #btn-salvar-edicao {
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 1000;
            display: none;
        }

        .tabela-wrapper {
            width: 100% !important;
            overflow-x: auto !important;
            display: block !important;
            margin-top: 10px !important;
        }

        .tabela-wrapper table {
            min-width: 950px !important;
            width: 100% !important;
            border-collapse: collapse !important;
        }

        .tabela-wrapper th,
        .tabela-wrapper td {
            white-space: nowrap !important;
            font-size: 13px !important;
            padding: 2px 3px !important;
            text-align: center !important;
        }

        /* Estilos para bot√µes de an√°lise */
        .botao-analise {
            padding: 10px 20px;
            background-color: #2C3E50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease;
        }

        .botao-analise:hover {
            background-color: #34495e;
            color: white;
            text-decoration: none;
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/awesome.all.min.css') }}"/>
</head>

<body>

<div class="content">
    <input type="hidden" id="nome-motorista" value="{{ motorist_id }} - {{ motorist }}">
    <div style="margin-bottom: 20px;">
        <strong>Placa:</strong> {{ plate }} |
        <strong>Motorista:</strong> {{ motorist }} |
        <strong>Data Inicial:</strong> {{ data_inicial }} |
        <strong>Data Final:</strong> {{ data_final }}
    </div>

    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
        <a href="{{ url_for('jornada.track') }}?placa={{ placa }}" class="botao-analise">üîÑ Iniciar Nova An√°lise</a>
        <button class="botao-analise" onclick="salvarAnalise('{{ motorist_id }}', '{{ plate }}')">üëÅÔ∏è Pr√©-visualiza√ß√£o
        </button>
    </div>

    <div id="blocos-dinamicos">
        {% for bloco in blocos %}
        {% if loop.first %}
            <div class="bloco-dia" data-bloco="{{ loop.index0 }}" style="display: block;">
        {% else %}
            <div class="bloco-dia" data-bloco="{{ loop.index0 }}" style="display: none;">
        {% endif %}
            <h2>Bloco {{ loop.index }} - {{ bloco.data_bloco }} ({{ bloco.dia_semana }})</h2>

            <div class="navegacao-bloco" style="text-align: right; margin-top: 15px;">
                {% if not loop.first %}
                <button onclick="navegarBloco(-1)">‚¨Ö Anterior</button>
                {% endif %}
                {% if not loop.last %}
                <button onclick="navegarBloco(1)">Pr√≥ximo ‚û°</button>
                {% endif %}
            </div>

            {% if not bloco.sem_movimento %}
            <div style="display: flex; gap: 20px; justify-content: space-between;">
                <div style="flex: 1;">
                    <h3>In√≠cio de Jornada por Movimento</h3>
                    <table class="tabela-jornada">
                        <tr>
                            <th>Hora</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Maps</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td><input type="time" value="{{ bloco.inicio_movimento.hora.strftime('%H:%M')}}"></td>
                            <td><input type="text" readonly value="{{ bloco.inicio_movimento.lat }}"></td>
                            <td><input type="text" readonly value="{{ bloco.inicio_movimento.lon }}"></td>
                            <td><a href="{{ bloco.inicio_movimento.link }}" target="_blank">Abrir</a></td>
                            <td><select>
                                <option></option>
                                <option>V√°lido</option>
                            </select></td>
                        </tr>
                    </table>
                </div>

                <div style="flex: 1;">
                    <h3>In√≠cio de Jornada por Igni√ß√£o</h3>
                    <table class="tabela-jornada">
                        <tr>
                            <th>Hora</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Maps</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td><input type="time" value="{{ bloco.inicio_ignicao.hora.strftime('%H:%M') }}"></td>
                            <td><input type="text" readonly value="{{ bloco.inicio_ignicao.lat }}"></td>
                            <td><input type="text" readonly value="{{ bloco.inicio_ignicao.lon }}"></td>
                            <td><a href="{{ bloco.inicio_ignicao.link }}" target="_blank">Abrir</a></td>
                            <td><select>
                                <option></option>
                                <option>V√°lido</option>
                            </select></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-top: 10px; justify-content: space-between;">
                <div style="flex: 1;">
                    <h3>Fim de Jornada por Movimento</h3>
                    <table class="tabela-jornada">
                        <tr>
                            <th>Hora</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Maps</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td><input type="time" value="{{ bloco.fim_movimento.hora.strftime('%H:%M') }}"></td>
                            <td><input type="text" readonly value="{{ bloco.fim_movimento.lat }}"></td>
                            <td><input type="text" readonly value="{{ bloco.fim_movimento.lon }}"></td>
                            <td><a href="{{ bloco.fim_movimento.link }}" target="_blank">Abrir</a></td>
                            <td><select>
                                <option></option>
                                <option>V√°lido</option>
                            </select></td>
                        </tr>
                    </table>
                </div>

                <div style="flex: 1;">
                    <h3>Fim de Jornada por Igni√ß√£o</h3>
                    <table class="tabela-jornada">
                        <tr>
                            <th>Hora</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Maps</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td><input type="time" value="{{ bloco.fim_ignicao.hora.strftime('%H:%M') }}"></td>
                            <td><input type="text" readonly value="{{ bloco.fim_ignicao.lat }}"></td>
                            <td><input type="text" readonly value="{{ bloco.fim_ignicao.lon }}"></td>
                            <td><a href="{{ bloco.fim_ignicao.link }}" target="_blank">Abrir</a></td>
                            <td><select>
                                <option></option>
                                <option>V√°lido</option>
                            </select></td>
                        </tr>
                    </table>
                </div>
            </div>


            <!-- Dados para An√°lise -->
            <h3 style="margin-top: 15px;">Dados para An√°lise</h3>
            <table class="tabela-jornada">
                <tr>
                    <th>In√≠cio</th>
                    <th>Fim</th>
                    <th>Lat</th>
                    <th>Lon</th>
                    <th>Cidade</th>
                    <th>Endere√ßo</th>
                    <th>Maps</th>
                    <th>Tempo</th>
                    <th>Valida√ß√£o</th>
                </tr>
                {% for parada in bloco.paradas %}
                <tr>
                    <td><input type="time" class="campo-inicio" value="{{ parada.inicio }}"></td>
                    <td><input type="time" class="campo-fim" value="{{ parada.fim }}"></td>
                    <td><input type="text" readonly value="{{ parada.lat }}"></td>
                    <td><input type="text" readonly value="{{ parada.lon }}"></td>
                    <td><input type="text" readonly value="{{ parada.cidade }}"></td>
                    <td><input type="text" readonly value="{{ parada.rua }}"></td>
                    <td><a href="{{ parada.link }}" target="_blank">Abrir</a></td>
                    <td><input type="time" value="{{ parada.tempo }}" class="campo-tempo" readonly/></td>
                    <td>
                        <select>
                            <option></option>
                            <option>REFEI√á√ÉO</option>
                            <option>DESCANSO</option>
                            <option>CARGA/DESCARGA</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <!-- BLOCO ESPECIAL SEM MOVIMENTO -->
            <div style="margin-top: 20px; background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 6px;">
                {% if bloco.get('inicio_ignicao') is none or bloco.get('fim_ignicao') is none %}
                <h3 style="margin-top: 0; color: #856404;">N√£o houve movimento para o ve√≠culo buscado nesta data.</h3>
                <p><strong>Link Maps:</strong>
                    <a href="{{ bloco.local_sem_movimento.link }}" target="_blank">
                        {{ bloco.local_sem_movimento.lat }}, {{ bloco.local_sem_movimento.lon }}
                    </a>
                </p>
                {% else %}
                <h3 style="margin-top: 0; color: #856404;">Nessa data houve somente movimenta√ß√£o por igni√ß√£o.</h3>
                <p><strong>Link Maps:</strong>
                    <a href="{{ bloco.local_sem_movimento.link }}" target="_blank">
                        {{ bloco.local_sem_movimento.lat }}, {{ bloco.local_sem_movimento.lon }}
                    </a>
                    <strong> In√≠cio da igni√ß√£o: </strong>{{ bloco.inicio_ignicao }}
                    <strong> Fim da igni√ß√£o: </strong>{{ bloco.fim_ignicao }}
                </p>
                {% endif %}

                <label><strong>Motivo:</strong></label>
                <select class="campo-observacao" onchange="toggleCamposHorarios(this)">
                    <option></option>
                    <option>Folga</option>
                    <option>Manuten√ß√£o</option>
                    <option>Carga e descarga</option>
                    <option>CARGA/DESCARGA</option>
                    <option>Garagem</option>
                    <option>Definir hor√°rio</option>
                </select>

                <div class="campos-horarios" style="margin-top: 10px; display: none;">
                    <div class="campos-outros">
                        <label>In√≠cio de Refei√ß√£o:</label>
                        <input type="time"><br>
                        <label>Fim de Refei√ß√£o:</label>
                        <input type="time">
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% endfor %}
    </div>

    <br>
    <!-- Modal de Confirma√ß√£o -->
    <div id="modal-confirmacao" class="modal-overlay" style="display: none;">
        <div class="modal-conteudo">
            <button class="modal-close-btn" onclick="document.getElementById('modal-confirmacao').style.display='none'">‚úñ</button>
            <h2 style="margin: 5px">Confirma√ß√£o de An√°lise</h2>

            <div style="margin: 5px"><strong>Motorista:</strong> {{ motorist }} | <strong>Data Inicial:</strong> {{
                data_inicial }} |
                <strong>Data Final:</strong> {{ data_final }}
            </div>

            <div class="botoes-modal" style="margin: 5px">
                <button class="botao-analise"
                        onclick="enviarTabelaComoJSON(motorist_id='{{ motorist_id }}', motorist_name='{{ motorist }}', truck_id='{{ truck_id }}', plate='{{ plate }}', acao='salvar')">
                    ‚úÖ Confirmar An√°lise
                </button>
            </div>

            <div style="overflow-x: auto; margin-top: 20px">
                <table id="tabela-confirmacao" class="tabela-jornada">
                    <!-- Conte√∫do inserido por JS -->
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleCamposHorarios(select) {
        var wrapper = select.closest('.campos-horarios') || select.parentElement.querySelector('.campos-horarios');
        if (!wrapper) wrapper = select.parentElement.nextElementSibling;
        if (!wrapper) return;
        var motivo = select.value.toLowerCase();
        var camposOutros = wrapper.querySelector('.campos-outros');
        if (motivo === 'definir hor√°rio') {
            wrapper.style.display = '';
            if (camposOutros) camposOutros.style.display = '';
        } else {
            wrapper.style.display = 'none';
        }
    }
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.campo-observacao').forEach(function(sel) {
            sel.addEventListener('change', function() { toggleCamposHorarios(this); });
        });
    });
    document.addEventListener("DOMContentLoaded", configurarEventosTempoParada);
</script>
</body>
</html>
