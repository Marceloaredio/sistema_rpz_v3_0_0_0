<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPZ - Parâmetros de Fechamento</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/content.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>

    <!-- Inclui o componente de progresso -->
    {% include 'partials/progress_bar.html' %}

    <style>
        /* Sobrescreve apenas nesta tela o .content para ocupar todo o espaço ao lado da sidebar */
        .content {
            margin: 0 !important;
            max-width: none !important;
            padding: 0 !important;
            background: none !important;
        }
        .parameters-container {
            margin-left: 180px; /* Compensa a sidebar fixa */
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        @media (max-width: 900px) {
            .parameters-container {
                margin-left: 0;
            }
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .page-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5em;
            color: white;
        }

        .card-icon.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-icon.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .card-icon.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .card-icon.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .card-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .card-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }

        .form-control {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
            display: block;
        }
        .currency-input {
            max-width: none;
            margin: 0 0 8px 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .form-group label {
            margin-left: 4px;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        .criterio-values {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .criterio-values > div {
            flex: 1;
        }
        /* Feriados grid */
        #feriados-lista {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        @media (max-width: 900px) {
            #feriados-lista {
                grid-template-columns: 1fr;
            }
        }
        .feriado-item {
            min-width: 0;
        }
        .add-form {
            max-width: 800px;
            margin: 0 auto 20px auto;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .criterio-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .criterio-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .criterio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .criterio-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .criterio-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .criterio-actions {
            display: flex;
            gap: 10px;
        }

        .feriado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .feriado-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .feriado-info {
            flex-grow: 1;
        }

        .feriado-date {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .feriado-desc {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 3px;
        }

        .feriado-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 15px;
        }

        .feriado-type.nacional {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .feriado-type.regional {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .add-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .hidden {
            display: none;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
            margin: 30px 0;
            border-radius: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Feriados grid horizontal */
        #feriados-lista {
            display: flex;
            flex-direction: row;
            gap: 18px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-top: 20px;
            scrollbar-width: thin;
        }
        .feriado-item {
            min-width: 240px;
            max-width: 260px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.07);
            border: 1.5px solid #e9ecef;
            padding: 18px 18px 12px 18px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: space-between;
            position: relative;
        }
        .feriado-date {
            font-weight: 700;
            color: #667eea;
            font-size: 1.15em;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .feriado-desc {
            color: #7f8c8d;
            font-size: 0.98em;
            margin-bottom: 8px;
        }
        .feriado-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .feriado-type.nacional {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .feriado-type.regional {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .feriado-item .btn-danger {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 10px;
            font-size: 1em;
        }
        @media (max-width: 900px) {
            #feriados-lista {
                gap: 10px;
            }
            .feriado-item {
                min-width: 180px;
                max-width: 200px;
                padding: 12px 10px 8px 10px;
            }
        }
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .criterio-values {
                grid-template-columns: 1fr;
            }
        }
        /* Feriados grid responsivo */
        #feriados-lista {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 20px;
            overflow-x: unset;
            padding-bottom: 0;
        }
        .feriado-item {
            min-width: 0;
            max-width: 100%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.07);
            border: 1.5px solid #e9ecef;
            padding: 18px 18px 12px 18px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: space-between;
            position: relative;
        }
        @media (max-width: 900px) {
            #feriados-lista {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .feriado-item {
                padding: 12px 10px 8px 10px;
            }
        }
        /* Valores padrão na horizontal */
        .valores-padrao-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .valores-padrao-row .form-group {
            flex: 1 1 220px;
            margin-bottom: 0;
        }
        /* Valores padrão no topo, horizontal, largura total */
        .valores-padrao-top {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 32px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid #bbdefb;
            padding: 25px 25px 20px 25px;
            margin-bottom: 28px;
            width: 100%;
            max-width: 950px;
            position: relative;
            flex-wrap: wrap;
        }
        .valores-padrao-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196f3 0%, #9c27b0 100%);
            border-radius: 15px 15px 0 0;
        }
        .valores-padrao-top .form-group.highlight {
            flex: 1 1 220px;
            min-width: 180px;
            max-width: 320px;
            margin-bottom: 0;
        }
        .valores-padrao-top .currency-input {
            width: 100%;
        }
        .valores-padrao-top .btn {
            margin-left: 32px;
            height: 44px;
            min-width: 160px;
            align-self: flex-end;
        }
        /* Destaque para campos de valores importantes */
        .form-control.highlight {
            background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
            border: 2px solid #ffb74d;
            font-size: 16px;
            font-weight: 600;
            color: #e65100;
            padding: 12px 15px;
            box-shadow: 0 2px 8px rgba(255, 183, 77, 0.2);
        }
        .form-control.highlight:focus {
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .form-group.highlight label {
            font-weight: 700;
            color: #e65100;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group.highlight label::before {
            content: '💰';
            font-size: 1.2em;
        }
        /* Critérios especiais com destaque */
        .criterio-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.07);
            border: 1.5px solid #e9ecef;
            padding: 15px 15px 12px 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        .criterio-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #4caf50 0%, #8bc34a 100%);
            border-radius: 12px 0 0 12px;
        }
        .criterio-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .criterio-title {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .criterio-title::before {
            content: '🎯';
            font-size: 1.1em;
        }
        .criterio-values {
            display: flex;
            gap: 15px;
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .criterio-values > div {
            flex: 1 1 120px;
            min-width: 120px;
            max-width: 220px;
        }
        .criterio-values b {
            color: #d32f2f;
        }
        /* Feriados com destaque nacional */
        .feriado-item.nacional {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border: 2px solid #4caf50;
        }
        .feriado-item.nacional::before {
            content: '🇧🇷';
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.2em;
        }
        .feriado-item.regional {
            background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
            border: 2px solid #ff9800;
        }
        .feriado-item.regional::before {
            content: '🏛️';
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.2em;
        }
        .feriado-date {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.15em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 25px;
        }
        .feriado-desc {
            color: #555;
            font-size: 0.98em;
            margin-bottom: 8px;
            padding-left: 25px;
        }
        .feriado-type {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
            margin-left: 25px;
        }
        .feriado-type.nacional {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }
        .feriado-type.regional {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
        }
        /* Seletor de ano com destaque */
        .ano-seletor-container {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #4caf50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ano-seletor-container label {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1em;
            margin: 0;
        }
        .ano-seletor-container label::before {
            content: '📅';
            margin-right: 8px;
        }
        .ano-seletor-container select {
            background: white;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 600;
            color: #2e7d32;
        }
        /* Botões com ícones */
        .btn i {
            margin-right: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
        }
        /* Responsividade */
        @media (max-width: 1100px) {
            .valores-padrao-top { max-width: 100%; }
        }
        @media (max-width: 900px) {
            .valores-padrao-top {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                padding: 20px 10px 15px 10px;
            }
            .valores-padrao-top .btn {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                min-width: 0;
            }
            .criterio-values {
                flex-direction: column;
                gap: 8px;
            }
            .ano-seletor-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
        /* Critérios especiais: garantir alinhamento dos inputs */
        .form-row.criterios-valores, .criterio-values {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            justify-content: space-between;
            align-items: flex-end;
        }
        .form-row.criterios-valores .form-group.highlight, .criterio-values > div {
            flex: 1;
            min-width: 0;
            max-width: none;
            display: flex;
            flex-direction: column;
        }
        @media (max-width: 900px) {
            .form-row.criterios-valores, .criterio-values {
                flex-direction: column;
                gap: 12px;
            }
            .form-row.criterios-valores .form-group.highlight, .criterio-values > div {
                max-width: 100%;
                min-width: 0;
            }
        }
        /* Ajuste para inputs: remover margens automáticas e centralizações */
        .form-group, .form-group.highlight {
            margin-bottom: 8px;
            align-items: stretch;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .currency-input {
            width: 100%;
            margin: 0;
        }
        .currency-input input {
            height: 40px;
            box-sizing: border-box;
            padding: 10px 12px;
        }
        .form-control {
            width: 100%;
            max-width: 100%;
            margin: 0;
            height: 40px;
            box-sizing: border-box;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        /* Ajuste específico para o dropdown de carga horária */
        #carga-horaria-criterio {
            height: 40px;
            padding: 10px 12px;
        }
        /* Cards de feriados: 2 por linha no desktop, 1 no mobile */
        #feriados-lista {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
            overflow-x: unset;
            padding-bottom: 0;
        }
        @media (max-width: 900px) {
            #feriados-lista {
                grid-template-columns: 1fr;
            }
        }
        .feriado-item {
            min-width: 0;
            max-width: 100%;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(102,126,234,0.05);
            border: 1px solid #e0e0e0;
            padding: 10px 10px 6px 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
            font-size: 0.97em;
            min-height: 90px;
        }
        .feriado-date {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1em;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding-left: 0;
        }
        .feriado-badge {
            font-size: 1em;
            color: #388e3c;
            font-weight: bold;
            margin-right: 4px;
            display: inline-block;
            vertical-align: middle;
        }
        .feriado-desc {
            color: #555;
            font-size: 0.93em;
            margin-bottom: 4px;
            padding-left: 0;
        }
        .feriado-type {
            padding: 3px 10px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 4px;
            margin-left: 0;
        }
        .feriado-type.nacional {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }
        .feriado-type.regional {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
        }
        .feriado-item .btn-danger {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 4px 8px;
            font-size: 0.95em;
        }
        .feriado-item.nacional {
            background: #e8f5e8;
            border: 1.5px solid #4caf50;
        }
        .feriado-item.nacional::before {
            display: none;
        }
        .feriado-item.regional {
            background: #fff8e1;
            border: 1.5px solid #ff9800;
        }
        .feriado-item.regional::before {
            display: none;
        }
        @media (max-width: 900px) {
            #feriados-lista {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            .feriado-item {
                padding: 7px 5px 4px 5px;
                font-size: 0.93em;
            }
        }
        @media (max-width: 600px) {
            #feriados-lista {
                grid-template-columns: 1fr;
            }
        }
        /* Força o .content a ocupar 100% da largura e remove centralização */
        .content {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background: none !important;
            display: block !important;
        }
        /* Remove max-width e centralização do .parameters-container */
        .parameters-container {
            max-width: none !important;
            margin: 0 !important;
        }
        /* Grid dos cards responsivo e fluido ocupando todo o espaço */
        .cards-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            gap: 25px;
            margin-bottom: 30px;
            justify-items: stretch !important;
        }
        .card {
            width: 100% !important;
            min-width: 0 !important;
            box-sizing: border-box !important;
        }
        /* Inputs nunca ultrapassam o card */
        .form-control, .currency-input input, input[type='number'], input[type='text'] {
            max-width: 100% !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        .card {
            min-width: 0 !important;
            overflow: hidden !important;
        }
        /* Critérios Especiais em Grid de 2 por linha */
        #criterios-lista {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }
        @media (max-width: 900px) {
            #criterios-lista {
                grid-template-columns: 1fr;
            }
        }
        .criterio-item {
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
            width: 100%;
        }
        /* Critérios Especiais: 1 por linha */
        #criterios-lista {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        /* Padronização dos botões de ação */
        .criterio-actions, .feriado-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn, .btn-sm {
            min-width: 28px;
            min-height: 28px;
            width: 28px;
            height: 28px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 0 !important;
            font-size: 0.9em !important;
            border-radius: 8px !important;
        }

        .btn i {
            margin: 0 !important;
            font-size: 1em !important;
        }

        /* Ajuste para botões dos feriados */
        .feriado-item .btn-danger, .feriado-item .btn-warning {
            position: static !important;
            margin-left: 8px;
        }
        /* Botão excluir dos feriados no topo direito */
        .feriado-item {
            position: relative;
        }
        .feriado-item .btn-danger {
            position: absolute !important;
            top: 10px;
            right: 10px;
            min-width: 28px;
            min-height: 28px;
            width: 28px;
            height: 28px;
            z-index: 2;
        }

        /* Botões principais (adicionar) grandes */
        .btn:not(.btn-danger):not(.btn-warning):not(.btn-sm) {
            min-width: 44px;
            min-height: 44px;
            width: auto;
            height: auto;
            padding: 12px 24px !important;
            font-size: 1em !important;
            border-radius: 8px !important;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>
<body>
<div class="content">
    <div class="parameters-container">
        <!-- Header da Página -->
        <div class="page-header">
            <h1><i class="fas fa-cogs"></i> Parâmetros de Fechamento</h1>
            <p>Configure os valores padrão, critérios especiais e feriados que influenciam nos cálculos do sistema</p>
        </div>

        <!-- Alertas -->
        <div id="alert-container"></div>

        <!-- Estatísticas Rápidas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ criterios|length }}</div>
                <div class="stat-label">Critérios Especiais</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ feriados|length }}</div>
                <div class="stat-label">Feriados Configurados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-diaria">{{ parametros.diaria_padrao.valor if parametros.diaria_padrao else '90.00' }}</div>
                <div class="stat-label">Diária Padrão</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-alimentacao">{{ parametros.ajuda_alimentacao.valor if parametros.ajuda_alimentacao else '0.00' }}</div>
                <div class="stat-label">Ajuda Alimentação</div>
            </div>
        </div>

        <!-- Card de Valores Padrão no topo -->
        <div class="valores-padrao-top">
            <div class="form-group highlight">
                <label for="diaria-padrao">Valor da Diária Padrão</label>
                <div class="currency-input">
                    <input type="text" id="diaria-padrao" class="form-control highlight" 
                           value="{{ parametros.diaria_padrao.valor if parametros.diaria_padrao else '90.00' }}" 
                           onblur="formatarInputMoeda(this)">
                </div>
            </div>
            <div class="form-group highlight">
                <label for="ajuda-alimentacao">Valor da Ajuda Alimentação</label>
                <div class="currency-input">
                    <input type="text" id="ajuda-alimentacao" class="form-control highlight" 
                           value="{{ parametros.ajuda_alimentacao.valor if parametros.ajuda_alimentacao else '0.00' }}" 
                           onblur="formatarInputMoeda(this)">
                </div>
            </div>
            <button class="btn btn-primary" onclick="salvarValoresPadrao()">
                <i class="fas fa-save"></i> Salvar Valores
            </button>
        </div>
        <!-- Cards de Critérios Especiais e Feriados -->
        <div class="cards-grid" style="align-items: stretch;">
            <!-- Card Critérios Especiais -->
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <div class="card-icon success">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div>
                        <h3 class="card-title">Critérios Especiais</h3>
                        <p class="card-subtitle">Regras personalizadas para valores específicos</p>
                    </div>
                </div>
                <div class="add-form">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">
                        <i class="fas fa-plus-circle"></i> Adicionar Novo Critério
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="valor-filtro">Motivo/Placa</label>
                            <input type="text" id="valor-filtro" class="form-control" 
                                   placeholder="Ex: GARAGEM, FOLGA, etc.">
                        </div>
                    </div>
                    <div class="form-row criterios-valores">
                        <div class="form-group highlight">
                            <label for="valor-diaria-criterio">Valor da Diária (R$)</label>
                            <div class="currency-input">
                                <input type="text" id="valor-diaria-criterio" class="form-control highlight" 
                                       onblur="formatarInputMoeda(this)">
                            </div>
                        </div>
                        <div class="form-group highlight">
                            <label for="valor-ajuda-criterio">Ajuda Alimentação (R$)</label>
                            <div class="currency-input">
                                <input type="text" id="valor-ajuda-criterio" class="form-control highlight" 
                                       onblur="formatarInputMoeda(this)">
                            </div>
                        </div>
                        <div class="form-group highlight">
                            <label for="carga-horaria-criterio">Carga Horária</label>
                            <select id="carga-horaria-criterio" class="form-control highlight">
                                <option value="Padrão">Padrão</option>
                                <option value="00:00">00:00</option>
                                <option value="01:00">01:00</option>
                                <option value="02:00">02:00</option>
                                <option value="03:00">03:00</option>
                                <option value="04:00">04:00</option>
                                <option value="05:00">05:00</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="descricao-criterio">Descrição (Opcional)</label>
                        <input type="text" id="descricao-criterio" class="form-control" 
                               placeholder="Ex:Motoristas na garagem não recebem diária, somente ajuda alimentação">
                    </div>
                    <button class="btn btn-success" onclick="adicionarCriterio()">
                        <i class="fas fa-plus"></i> Adicionar Critério
                    </button>
                </div>
                <div id="criterios-lista"></div>
            </div>
            <!-- Card Feriados Regionais -->
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <div class="card-icon info">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div>
                        <h3 class="card-title">Feriados Nacionais e Regionais</h3>
                        <p class="card-subtitle">Configure feriados locais e nacionais</p>
                    </div>
                </div>
                <div class="add-form">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">
                        <i class="fas fa-plus-circle"></i> Adicionar Novo Feriado
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data-feriado">Data</label>
                            <input type="date" id="data-feriado" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="tipo-feriado">Tipo</label>
                            <select id="tipo-feriado" class="form-control">
                                <option value="regional">Regional</option>
                                <option value="nacional">Nacional</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="descricao-feriado">Descrição</label>
                        <input type="text" id="descricao-feriado" class="form-control" 
                               placeholder="Ex: Feriado Municipal, Carnaval, etc.">
                    </div>
                    <button class="btn btn-success" onclick="adicionarFeriado()">
                        <i class="fas fa-plus"></i> Adicionar Feriado
                    </button>
                </div>
                <div class="ano-seletor-container">
                    <label for="ano-seletor">Ano dos Feriados:</label>
                    <select id="ano-seletor" class="form-control"></select>
                </div>
                <div id="feriados-lista">
                    <!-- Feriados renderizados por JS -->
                        </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
// @ts-ignore - Template Jinja2
let editandoCriterio = null;
// @ts-ignore - Template Jinja2
let criterios = {{ criterios|tojson|safe }};
let feriadosPorAno = {};
let anoSelecionado = new Date().getFullYear();

// Funções de formatação de moeda brasileira
function formatarMoeda(valor) {
    // Converte para número e trata valores inválidos
    let numero = parseFloat(valor);
    if (isNaN(numero)) {
        numero = 0;
    }
    
    // Formata como moeda brasileira
    return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatarInputMoeda(input) {
    // Remove tudo que não é número
    let valor = input.value.replace(/[^\d,.-]/g, '');
    
    // Converte vírgula para ponto para cálculo
    valor = valor.replace(',', '.');
    
    // Converte para número
    let numero = parseFloat(valor);
    if (isNaN(numero)) {
        numero = 0;
    }
    
    // Formata e aplica no input
    input.value = formatarMoeda(numero);
}

function obterValorNumerico(input) {
    // Remove formatação e retorna apenas o número
    let valor = input.value.replace(/[^\d,.-]/g, '');
    valor = valor.replace(',', '.');
    let numero = parseFloat(valor);
    return isNaN(numero) ? 0 : numero;
}

function aplicarFormatacaoMoeda() {
    // Aplicar formatação nos inputs de valores padrão
    const inputsMoeda = document.querySelectorAll('#diaria-padrao, #ajuda-alimentacao, #valor-diaria-criterio, #valor-ajuda-criterio');
    
    inputsMoeda.forEach(input => {
        // Formatar valor atual
        if (input.value && input.value.trim() !== '') {
            formatarInputMoeda(input);
        }
        
        // Adicionar evento para formatar ao sair do input
        input.addEventListener('blur', function() {
            formatarInputMoeda(this);
        });
        
        // Adicionar evento para formatar ao pressionar Enter
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                formatarInputMoeda(this);
                this.blur();
            }
        });
    });
}

function formatarValoresIniciais() {
    // Formatar estatísticas
    const statDiaria = document.getElementById('stat-diaria');
    const statAlimentacao = document.getElementById('stat-alimentacao');
    
    if (statDiaria) {
        let valorDiaria = statDiaria.textContent;
        // Remove formatação existente e converte para número
        valorDiaria = valorDiaria.replace(/[^\d,.-]/g, '').replace(',', '.');
        const numeroDiaria = parseFloat(valorDiaria) || 0;
        statDiaria.textContent = formatarMoeda(numeroDiaria);
    }
    
    if (statAlimentacao) {
        let valorAlimentacao = statAlimentacao.textContent;
        // Remove formatação existente e converte para número
        valorAlimentacao = valorAlimentacao.replace(/[^\d,.-]/g, '').replace(',', '.');
        const numeroAlimentacao = parseFloat(valorAlimentacao) || 0;
        statAlimentacao.textContent = formatarMoeda(numeroAlimentacao);
    }
    
    // Formatar inputs de valores padrão
    const diariaInput = document.getElementById('diaria-padrao');
    const alimentacaoInput = document.getElementById('ajuda-alimentacao');
    
    if (diariaInput) {
        let valorDiaria = diariaInput.value;
        // Remove formatação existente e converte para número
        valorDiaria = valorDiaria.replace(/[^\d,.-]/g, '').replace(',', '.');
        const numeroDiaria = parseFloat(valorDiaria) || 0;
        diariaInput.value = formatarMoeda(numeroDiaria);
    }
    
    if (alimentacaoInput) {
        let valorAlimentacao = alimentacaoInput.value;
        // Remove formatação existente e converte para número
        valorAlimentacao = valorAlimentacao.replace(/[^\d,.-]/g, '').replace(',', '.');
        const numeroAlimentacao = parseFloat(valorAlimentacao) || 0;
        alimentacaoInput.value = formatarMoeda(valorAlimentacao);
    }
}

// Função para atualizar o contador de critérios
function atualizarContadorCriterios() {
    const statCard = document.querySelector('.stat-card:nth-child(1) .stat-value');
    if (statCard) {
        statCard.textContent = criterios.length;
    }
}

// Função para renderizar a lista de critérios
function renderizarCriterios() {
    const lista = document.getElementById('criterios-lista');
    lista.innerHTML = '';
    if (criterios.length === 0) {
        lista.innerHTML = '<div style="color:#888; padding:20px; text-align:center;">Nenhum critério cadastrado.</div>';
        atualizarContadorCriterios();
        return;
    }
    criterios.forEach(criterio => {
        const div = document.createElement('div');
        div.className = 'criterio-item';
        div.setAttribute('data-id', criterio.id);
        if (editandoCriterio === criterio.id) {
            div.innerHTML = `
                <div class="criterio-header">
                    <div class="criterio-title">
                        <i class="fas fa-tag"></i> <input type="text" class="form-control criterio-filtro-edit" value="${criterio.valor_filtro}">
                    </div>
                    <div class="criterio-actions">
                        <button class="btn btn-success btn-sm" title="Salvar" onclick="salvarCriterio(${criterio.id})">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" title="Cancelar" onclick="cancelarEdicaoCriterio()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="criterio-values">
                    <div><b>Diária:</b> R$ <input type="text" class="form-control criterio-diaria-edit" value="${formatarMoeda(criterio.valor_diaria)}" onblur="formatarInputMoeda(this)"></div>
                    <div><b>Alimentação:</b> R$ <input type="text" class="form-control criterio-ajuda-edit" value="${formatarMoeda(criterio.valor_ajuda_alimentacao)}" onblur="formatarInputMoeda(this)"></div>
                    <div><b>Carga Horária:</b> 
                        <select class="form-control criterio-carga-horaria-edit">
                            <option value="Padrão" ${criterio.carga_horaria_especial === 'Padrão' ? 'selected' : ''}>Padrão</option>
                            <option value="00:00" ${criterio.carga_horaria_especial === '00:00' ? 'selected' : ''}>00:00</option>
                            <option value="01:00" ${criterio.carga_horaria_especial === '01:00' ? 'selected' : ''}>01:00</option>
                            <option value="02:00" ${criterio.carga_horaria_especial === '02:00' ? 'selected' : ''}>02:00</option>
                            <option value="03:00" ${criterio.carga_horaria_especial === '03:00' ? 'selected' : ''}>03:00</option>
                            <option value="04:00" ${criterio.carga_horaria_especial === '04:00' ? 'selected' : ''}>04:00</option>
                            <option value="05:00" ${criterio.carga_horaria_especial === '05:00' ? 'selected' : ''}>05:00</option>
                            <option value="06:00" ${criterio.carga_horaria_especial === '06:00' ? 'selected' : ''}>06:00</option>
                            <option value="07:00" ${criterio.carga_horaria_especial === '07:00' ? 'selected' : ''}>07:00</option>
                            <option value="08:00" ${criterio.carga_horaria_especial === '08:00' ? 'selected' : ''}>08:00</option>
                            <option value="09:00" ${criterio.carga_horaria_especial === '09:00' ? 'selected' : ''}>09:00</option>
                            <option value="10:00" ${criterio.carga_horaria_especial === '10:00' ? 'selected' : ''}>10:00</option>
                            <option value="11:00" ${criterio.carga_horaria_especial === '11:00' ? 'selected' : ''}>11:00</option>
                            <option value="12:00" ${criterio.carga_horaria_especial === '12:00' ? 'selected' : ''}>12:00</option>
                        </select>
                    </div>
                </div>
                <div class="criterio-desc"><input type="text" class="form-control criterio-desc-edit" value="${criterio.descricao ? criterio.descricao : ''}"></div>
            `;
        } else {
        div.innerHTML = `
            <div class="criterio-header">
                <div class="criterio-title">
                    <i class="fas fa-tag"></i> <span class="criterio-filtro">${criterio.valor_filtro}</span>
                </div>
                <div class="criterio-actions">
                    <button class="btn btn-warning btn-sm" title="Editar" onclick="editarCriterio(${criterio.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" title="Excluir" onclick="excluirCriterio(${criterio.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="criterio-values">
                <div><b>Diária:</b> ${formatarMoeda(criterio.valor_diaria)}</div>
                <div><b>Alimentação:</b> ${formatarMoeda(criterio.valor_ajuda_alimentacao)}</div>
                <div><b>Carga Horária:</b> ${criterio.carga_horaria_especial || 'Padrão'}</div>
            </div>
            <div class="criterio-desc">${criterio.descricao ? criterio.descricao : ''}</div>
        `;
        }
        lista.appendChild(div);
    });
    atualizarContadorCriterios();
}

function editarCriterio(criterioId) {
    editandoCriterio = criterioId;
    renderizarCriterios();
}

function cancelarEdicaoCriterio() {
    editandoCriterio = null;
    renderizarCriterios();
}

function salvarCriterio(criterioId) {
    progressManager.startOperation('Salvando Critério', 'Atualizando critério...');
    const criterioRow = document.querySelector(`[data-id="${criterioId}"]`);
    const valorFiltro = criterioRow.querySelector('.criterio-filtro-edit').value.trim();
    const valorDiaria = obterValorNumerico(criterioRow.querySelector('.criterio-diaria-edit'));
    const valorAjuda = obterValorNumerico(criterioRow.querySelector('.criterio-ajuda-edit'));
    const cargaHoraria = criterioRow.querySelector('.criterio-carga-horaria-edit').value;
    const descricao = criterioRow.querySelector('.criterio-desc-edit').value;
    $.ajax({
        url: '/api/params/criteria/update',
        type: 'POST',
        data: JSON.stringify({
            criterio_id: criterioId,
            valor_filtro: valorFiltro,
            valor_diaria: valorDiaria,
            valor_ajuda_alimentacao: valorAjuda,
            carga_horaria_especial: cargaHoraria,
            descricao: descricao
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Critério atualizado com sucesso!', 'success');
                // Atualizar localmente
                const idx = criterios.findIndex(c => c.id === criterioId);
                if (idx !== -1) {
                    criterios[idx].valor_filtro = valorFiltro;
                    criterios[idx].valor_diaria = valorDiaria;
                    criterios[idx].valor_ajuda_alimentacao = valorAjuda;
                    criterios[idx].carga_horaria_especial = cargaHoraria;
                    criterios[idx].descricao = descricao;
                }
                editandoCriterio = null;
                renderizarCriterios();
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao atualizar critério';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

// Função para mostrar alertas
function mostrarAlerta(mensagem, tipo = 'success') {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo}`;
    alertDiv.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${mensagem}
    `;
    alertContainer.appendChild(alertDiv);
    setTimeout(() => { alertDiv.remove(); }, 5000);
}

// Função para salvar valores padrão
function salvarValoresPadrao() {
    progressManager.startOperation('Salvando Valores', 'Atualizando parâmetros...');
    
    const diariaPadrao = obterValorNumerico(document.getElementById('diaria-padrao'));
    const ajudaAlimentacao = obterValorNumerico(document.getElementById('ajuda-alimentacao'));
    
    $.ajax({
        url: '/api/params/update',
        type: 'POST',
        data: JSON.stringify({
            diaria_padrao: diariaPadrao,
            ajuda_alimentacao: ajudaAlimentacao
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Valores salvos com sucesso!', 'success');
                // Atualizar os valores exibidos
                document.getElementById('diaria-padrao').value = formatarMoeda(diariaPadrao);
                document.getElementById('ajuda-alimentacao').value = formatarMoeda(ajudaAlimentacao);
                
                // Atualizar estatísticas
                const statDiaria = document.getElementById('stat-diaria');
                const statAlimentacao = document.getElementById('stat-alimentacao');
                if (statDiaria) statDiaria.textContent = formatarMoeda(diariaPadrao);
                if (statAlimentacao) statAlimentacao.textContent = formatarMoeda(ajudaAlimentacao);
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao salvar valores';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

// Função para adicionar critério (garantir limpeza e atualização):
function adicionarCriterio() {
    progressManager.startOperation('Adicionando Critério', 'Salvando novo critério...');
    const valorFiltro = document.getElementById('valor-filtro').value.trim();
    const valorDiaria = obterValorNumerico(document.getElementById('valor-diaria-criterio'));
    const valorAjuda = obterValorNumerico(document.getElementById('valor-ajuda-criterio'));
    const cargaHoraria = document.getElementById('carga-horaria-criterio').value;
    const descricao = document.getElementById('descricao-criterio').value.trim();

    // Debug dos valores
    console.log('valorFiltro:', valorFiltro, 'valorDiaria:', valorDiaria, 'valorAjuda:', valorAjuda, 'cargaHoraria:', cargaHoraria, 'descricao:', descricao);

    // Validação: só bloqueia se filtro estiver vazio ou valores não numéricos
    if (!valorFiltro || isNaN(valorDiaria) || isNaN(valorAjuda)) {
        progressManager.finishOperation(() => {
            mostrarAlerta('Preencha todos os campos obrigatórios!', 'danger');
        });
        return;
    }

    $.ajax({
        url: '/api/params/criteria/add',
        type: 'POST',
        data: JSON.stringify({
            valor_filtro: valorFiltro,
            valor_diaria: valorDiaria,
            valor_ajuda_alimentacao: valorAjuda,
            carga_horaria_especial: cargaHoraria,
            descricao: descricao
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Critério adicionado com sucesso!', 'success');
                // Limpar formulário
                document.getElementById('valor-filtro').value = '';
                document.getElementById('valor-diaria-criterio').value = '';
                document.getElementById('valor-ajuda-criterio').value = '';
                document.getElementById('carga-horaria-criterio').value = 'Padrão';
                document.getElementById('descricao-criterio').value = '';
                // Adicionar critério à lista local e renderizar
                if (response && response.criterio) {
                    criterios.push(response.criterio);
                    renderizarCriterios();
                } else if (response && response.reload) {
                    // Se o backend indica que deve recarregar, fazer reload
                    location.reload();
                } else {
                    // Fallback: recarregar a página
                    location.reload();
                }
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao adicionar critério';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

// Função para excluir critério
function excluirCriterio(criterioId) {
    if (!confirm('Tem certeza que deseja excluir este critério?')) {
        return;
    }
    progressManager.startOperation('Excluindo Critério', 'Removendo critério...');
    $.ajax({
        url: '/api/params/criteria/delete',
        type: 'POST',
        data: JSON.stringify({
            criterio_id: criterioId
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Critério excluído com sucesso!', 'success');
                criterios = criterios.filter(c => c.id !== criterioId);
                renderizarCriterios();
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao excluir critério';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

// FERIADOS
function preencherAnosFeriado() {
    // Mostrar apenas de 2025 a 2035
    const seletor = document.getElementById('ano-seletor');
    seletor.innerHTML = '';
    for (let i = 2025; i <= 2035; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        seletor.appendChild(opt);
    }
    // Seleciona o ano atual se estiver no range, senão seleciona 2025
    if (anoSelecionado >= 2025 && anoSelecionado <= 2035) {
        seletor.value = anoSelecionado;
    } else {
        seletor.value = 2025;
        anoSelecionado = 2025;
    }
}

function carregarFeriadosNacionais(ano) {
    const feriadosNacionais = [
        { data: '01-01', descricao: 'Confraternização Universal', tipo: 'nacional' },
        { data: '21-04', descricao: 'Tiradentes', tipo: 'nacional' },
        { data: '01-05', descricao: 'Dia do Trabalho', tipo: 'nacional' },
        { data: '07-09', descricao: 'Independência do Brasil', tipo: 'nacional' },
        { data: '12-10', descricao: 'Nossa Senhora Aparecida', tipo: 'nacional' },
        { data: '02-11', descricao: 'Finados', tipo: 'nacional' },
        { data: '15-11', descricao: 'Proclamação da República', tipo: 'nacional' },
        { data: '25-12', descricao: 'Natal', tipo: 'nacional' }
    ];
    
    // Adicionar feriados nacionais se não existirem
    feriadosNacionais.forEach(feriado => {
        const dataCompleta = `${feriado.data}-${ano}`;
        // Verificar se já existe
        const existe = feriadosPorAno[ano]?.some(f => f.data === dataCompleta && f.tipo === 'nacional');
        if (!existe) {
            adicionarFeriadoNacional(dataCompleta, feriado.descricao, ano);
        }
    });
}

function adicionarFeriadoNacional(data, descricao, ano) {
    $.ajax({
        url: '/api/params/holidays/add',
        type: 'POST',
        data: JSON.stringify({
            data: data,
            descricao: descricao,
            tipo: 'nacional',
            ano: ano
        }),
        contentType: 'application/json',
        success: function(response) {
            console.log('Feriado nacional adicionado:', data);
        },
        error: function(xhr) {
            console.log('Feriado nacional já existe ou erro:', data);
        }
    });
}

function renderizarFeriados() {
    const lista = document.getElementById('feriados-lista');
    lista.innerHTML = '';
    const feriados = feriadosPorAno[anoSelecionado] || [];
    
    console.log('Renderizando feriados para ano:', anoSelecionado);
    console.log('Feriados disponíveis:', feriados);
    console.log('Tamanho do array:', feriados.length);
    
    if (feriados.length === 0) {
        console.log('Nenhum feriado encontrado, mostrando mensagem');
        lista.innerHTML = '<div style="color:#888; padding:20px; text-align:center;">Nenhum feriado cadastrado para este ano.</div>';
        return;
    }
    
    console.log('Renderizando', feriados.length, 'feriados');
    feriados.forEach(feriado => {
        const dataParts = feriado.data.split('-'); // DD-MM-YYYY
        const dataISO = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`; // YYYY-MM-DD
        const dataObj = new Date(dataISO + 'T00:00:00'); // Força local
        const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        const diaSemana = diasSemana[dataObj.getDay()];
        // Formatar data para dd/mm/YYYY
        const dataFormatada = `${dataParts[0]}/${dataParts[1]}/${dataParts[2]}`;
        const div = document.createElement('div');
        div.className = `feriado-item ${feriado.tipo}`;
        div.setAttribute('data-id', feriado.id);
        div.innerHTML = `
            <span class="feriado-badge">${feriado.tipo === 'nacional' ? 'BR' : ''}</span>
            <div class="feriado-date">
                <i class="fas fa-calendar-day"></i> ${dataFormatada} <span style="color:#666;font-size:0.95em;font-weight:500;">(${diaSemana})</span>
            </div>
            <div class="feriado-desc">${feriado.descricao}</div>
            <span class="feriado-type ${feriado.tipo}">${feriado.tipo === 'nacional' ? 'Nacional' : 'Regional'}</span>
            <button class="btn btn-danger btn-sm" onclick="excluirFeriado(${feriado.id})">
                <i class="fas fa-trash"></i>
            </button>
        `;
        lista.appendChild(div);
    });
}

function carregarFeriadosAno(ano) {
    progressManager.startOperation('Carregando Feriados', 'Buscando feriados do ano...');
    console.log('Carregando feriados para ano:', ano);
    $.ajax({
        url: '/api/params/holidays/get',
        type: 'GET',
        data: { ano: ano },
        success: function(response) {
            console.log('Resposta da API:', response);
            console.log('Feriados recebidos:', response.feriados);
            console.log('Tipo de feriados:', typeof response.feriados);
            console.log('Tamanho do array:', response.feriados ? response.feriados.length : 'undefined');
            
            feriadosPorAno[ano] = response.feriados;
            console.log('FeriadosPorAno após atribuição:', feriadosPorAno[ano]);
            
            renderizarFeriados();
            progressManager.finishOperation();
            // Carregar feriados nacionais automaticamente
            carregarFeriadosNacionais(ano);
        },
        error: function(xhr, status, error) {
            console.error('Erro na requisição:', xhr, status, error);
            progressManager.finishOperation(() => {
                mostrarAlerta('Erro ao carregar feriados do ano', 'danger');
            });
        }
    });
}

document.getElementById('ano-seletor').addEventListener('change', function() {
    anoSelecionado = parseInt(this.value);
    carregarFeriadosAno(anoSelecionado);
});

function adicionarFeriado() {
    progressManager.startOperation('Adicionando Feriado', 'Salvando novo feriado...');
    const data = document.getElementById('data-feriado').value; // 'YYYY-MM-DD'
    const descricao = document.getElementById('descricao-feriado').value;
    const tipo = document.getElementById('tipo-feriado').value;
    const ano = anoSelecionado;
    if (!data || !descricao) {
        progressManager.finishOperation(() => {
            mostrarAlerta('Preencha todos os campos obrigatórios!', 'danger');
        });
        return;
    }
    // Converter data para formato DD-MM-YYYY apenas por string
    const [anoStr, mesStr, diaStr] = data.split('-');
    const dataFormatada = `${diaStr}-${mesStr}-${anoStr}`;
    $.ajax({
        url: '/api/params/holidays/add',
        type: 'POST',
        data: JSON.stringify({
            data: dataFormatada,
            descricao: descricao,
            tipo: tipo,
            ano: ano
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Feriado adicionado com sucesso!', 'success');
                document.getElementById('data-feriado').value = '';
                document.getElementById('descricao-feriado').value = '';
                carregarFeriadosAno(anoSelecionado);
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao adicionar feriado';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

function excluirFeriado(feriadoId) {
    if (!confirm('Tem certeza que deseja excluir este feriado?')) {
        return;
    }
    progressManager.startOperation('Excluindo Feriado', 'Removendo feriado...');
    $.ajax({
        url: '/api/params/holidays/delete',
        type: 'POST',
        data: JSON.stringify({
            feriado_id: feriadoId,
            ano: anoSelecionado
        }),
        contentType: 'application/json',
        success: function(response) {
            progressManager.finishOperation(() => {
                mostrarAlerta('Feriado excluído com sucesso!', 'success');
                carregarFeriadosAno(anoSelecionado);
            });
        },
        error: function(xhr) {
            progressManager.finishOperation(() => {
                const error = xhr.responseJSON ? xhr.responseJSON.mensagem : 'Erro ao excluir feriado';
                mostrarAlerta(error, 'danger');
            });
        }
    });
}

// Inicialização
$(document).ready(function() {
    // Definir data mínima como hoje para o campo de data
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data-feriado').min = hoje;
    
    // Formatar valores iniciais
    formatarValoresIniciais();
    
    // Aplicar formatação de moeda
    aplicarFormatacaoMoeda();
    
    renderizarCriterios();
    preencherAnosFeriado();
    carregarFeriadosAno(anoSelecionado);
});
</script>
</body>
</html> 
